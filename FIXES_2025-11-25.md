# Fixes for CrowdSec and Fail2ban Integration Issues
**Date:** 2025-11-25
**Issue:** https://github.com/Commandershadow9/shadowops-bot/issues/5

## Summary
Fixed critical issues preventing CrowdSec and Fail2ban from working correctly, causing both services to show as "Inaktiv" in status reports.

## Root Causes Identified

### 1. Systemd NoNewPrivileges Flag (CRITICAL)
**Problem:** The systemd service had `NoNewPrivileges=true` set, which prevented the bot from using sudo commands.

**Error:**
```
sudo: The "no new privileges" flag is set, which prevents sudo from running as root.
```

**Impact:** All `sudo` calls for CrowdSec (`cscli`) and Fail2ban (`fail2ban-client`) were failing with exit code 1.

**Fix:** Disabled `NoNewPrivileges` in `/etc/systemd/system/shadowops-bot.service`
```diff
- NoNewPrivileges=true
+ #NoNewPrivileges=true  # Disabled to allow sudo for security tools
```

**Note:** While this slightly reduces sandboxing, it's necessary for the bot to interact with security tools. The user `cmdshadow` already has passwordless sudo access limited to specific commands only:
- `/usr/bin/fail2ban-client`
- `/usr/bin/cscli`
- `/usr/bin/systemctl`
- `/usr/bin/aide`
- `/usr/bin/journalctl`

### 2. CrowdSec JSON Parsing Bug
**Problem:** The code was incorrectly parsing CrowdSec's JSON output structure.

**Issue:** CrowdSec returns alerts with nested decisions:
```json
[
  {
    "decisions": [
      {
        "value": "161.118.206.188",
        "scenario": "crowdsecurity/http-cve-2021-41773",
        ...
      }
    ],
    "message": "IP performed attack...",
    ...
  }
]
```

The old code was treating top-level array items as decisions, resulting in all fields showing as "Unknown".

**Fix:** Updated `/home/cmdshadow/shadowops-bot/src/integrations/crowdsec.py` to correctly parse nested structure:
```python
# Old (incorrect)
for decision in data[:limit]:
    decisions.append({
        "ip": decision.get("value", "Unknown"),  # Wrong level!
        ...
    })

# New (correct)
for alert in data:
    for decision in alert.get("decisions", []):
        decisions.append({
            "ip": decision.get("value", "Unknown"),
            "reason": alert.get("message", "Unknown"),
            "scenario": decision.get("scenario", "Unknown"),
            ...
        })
```

## Verification

### Before Fix:
```
Test: get_jail_stats()
Stats: {}  # Empty - would show as "Inaktiv"

Test: get_active_decisions()
Decisions: [{'ip': 'Unknown', 'scenario': 'Unknown', ...}]
```

### After Fix:
```
Test: get_jail_stats()
Stats: {'docker-api-auth': {...}, 'sshd': {...}}  # Working!

Test: get_active_decisions()
Decisions: [{
    'ip': '161.118.206.188',
    'scenario': 'crowdsecurity/http-cve-2021-41773',
    'reason': 'Ip 161.118.206.188 performed...',
    ...
}]  # Correct data!
```

### Bot Logs After Fix:
```
üîç Starting CrowdSec watcher (3600s intervals)
üîç Starting Fail2ban watcher (3600s intervals)
üõ°Ô∏è CrowdSec: 2 neue Threats erkannt
```
No more "CrowdSec call failed" errors!

## Files Modified

1. `/etc/systemd/system/shadowops-bot.service`
   - Commented out `NoNewPrivileges=true`
   - Backup saved to `/etc/systemd/system/shadowops-bot.service.bak`

2. `/home/cmdshadow/shadowops-bot/src/integrations/crowdsec.py`
   - Fixed JSON parsing in `get_active_decisions()` method
   - Added debug logging for troubleshooting

## Commands Run

```bash
# Backup service file
sudo cp /etc/systemd/system/shadowops-bot.service /etc/systemd/system/shadowops-bot.service.bak

# Disable NoNewPrivileges
sudo sed -i 's/^NoNewPrivileges=true/#NoNewPrivileges=true  # Disabled to allow sudo for security tools/' /etc/systemd/system/shadowops-bot.service

# Reload and restart
sudo systemctl daemon-reload
sudo systemctl restart shadowops-bot.service
```

## Testing Recommendations

1. Run `/status` command in Discord to verify both services show as "üü¢ Aktiv"
2. Check for active CrowdSec decisions: `/bans`
3. Monitor logs for any "CrowdSec call failed" messages
4. Verify Fail2ban jail stats are being retrieved correctly

## Security Considerations

- The `NoNewPrivileges` flag has been disabled to allow sudo access
- This is mitigated by strict sudoers rules limiting the bot to specific commands only
- All sudo commands require explicit paths (e.g., `/usr/bin/cscli`)
- No wildcard sudo access is granted

## Related Issues

- GitHub Issue #5: Unresolved Issues with CrowdSec, Fail2ban, and AIDE
